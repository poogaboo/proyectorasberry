// Qaop/JS Copyright by Jan Bobrowski 2011-2016
function script(n,t){var e=$("head"),i=e.appendChild($e("script"));i.onload=function(){e.removeChild(i),t&&t()},i.src=n}function request(n,t,e){function i(){r(1,a.statusText||"Error")}function o(){if(n.type=n.type||a.getResponseHeader("Content-Type"),s)n.data=a.responseText;else if(t=a.response){var t=new Uint8Array(t);l?u(t):n.data=t}m&&ui.progress(f)}function u(t){var t,e,i,o,u,r;e=n.data,o=n.pos,e&&(i=e.length,u=i-o)&&(r=new Uint8Array(u+t.length),r.set(e.subarray(o,i)),r.set(t,u),t=r),n.data=t,n.pos=0}function r(t,i){n.eof=f.e=1,f.t=f.b=t,m&&ui.progress(f),i&&(n.data=null,ui.msg(i));var o=a&&a.responseURL;o&&(n.url=o),e&&e(n)}var c,a,f,s,l,m;if(t=t||{},m=!t.nopb,c=n.file)return n.type||(n.type=c.type),n.name||(n.name=c.name),a=new FileReader,(f=a.readAsArrayBuffer)?a.readAsArrayBuffer(c):a.readAsBinaryString(c),void(a.onloadend=function(){n.data=a.result,f&&(n.data=new Uint8Array(n.data)),n.eof=1,e(n)});if(f=n.url.match(/data:([^,;]+)(;base64)?,(.*)/i))try{n.type=f[1],n.data=f[2]?atob(f[3]):f[3].replace(/%[0-9a-f]{2}/gi,function(n){return String.fromCharCode("0x"+n.substr(1))})}catch(n){ui.msg(n)}finally{return n.eof=1,void setTimeout(e,0,n)}f={},a=new XMLHttpRequest,s=t.text||!("responseType"in a)||window.opera,a.onload=function(){return a.status&&200!=a.status?i():(o(),void r(n.data.length))},a.onerror=i,a.onabort=function(){e=null,r(0)},a.onprogress=function(t){return a.status&&200!=a.status?(a.abort(),a.onerror()):(f.b=t.loaded,f.t=t.total,f.b>f.t&&(f.t=f.b+9999),o(),void e(n))};try{m&&(ui.progress(t.color||"#E00"),ui.progress(f)),a.open("GET",n.url),s?t.text||a.overrideMimeType("text/plain;charset=x-user-defined"):(l=1,a.responseType="moz-chunked-arraybuffer",a.responseType||(a.responseType="arraybuffer",l=0)),a.setRequestHeader("Accept",t.acc||"*/*"),a.send()}catch(n){return void r(1,n.message)}return a}!function(){function n(n,t,e){var i,o,u=n.className;null==u&&(u=(n=$(n)).className),u=(u+"").split(" "),e="+-"[+(null!=e&&!e)];do t=t.match(/([-+])?(\S+)\s*(.*)/),o=t[1]||e,i=u.indexOf(t[2]),0>i?"-"==o||u.push(t[2]):"+"==o||u.splice(i,1);while(t=t[3]);return n.className=u.join(" "),n}function t(n,t){return n.matches?n.matches(t):n.webkitMatchesSelector?n.webkitMatchesSelector(t):$$(t).indexOf(n)>=0}function e(n){if(n.scrollIntoViewIfNeeded)return n.scrollIntoViewIfNeeded();var t=document,e=t.activeElement;e==n?e.blur():(n.focus(),t.activeElement!=n&&(n.tabIndex=-1,n.focus(),delete n.tabIndex,n.removeAttribute("tabindex"))),e.focus()}function i(){function n(n,t,e,i){var o,u=0,s=r,l=c;do o=s+e[u++],s=a*o,n[t++]=l=f*(l+o-s);while(--i);c=l,r=s}var t=this.AudioContext||this.webkitAudioContext;if(!t)throw"No audio";var e,i,o=[];e=new t,i=(e.createScriptProcessor||e.createJavaScriptNode).call(e,4096,1,1),i.onaudioprocess=function(t){for(var e,i,u,s=t.outputBuffer,l=s.getChannelData(0),m=0,d=l.length;(e=o.shift())&&(!(i=e.length)||(i>d&&o.unshift(e.subarray(i=d)),n(l,m,e,i),m+=i,d-=i)););if(d&&(c||r))do u=r,r*=a,c=f*(c+u-r),l[m++]=c;while(--d)},i.connect(e.destination),u=e.sampleRate,console.log(i);var u,r=0,c=0,a=Math.pow(2,-35e5/(700*u)),f=Math.pow(2,-35e5/(23256*u));return{hz:u,play:function(n){o.length>9&&o.shift(),o.push(n)}}}function o(n,t,e){function i(t,e){return(e=e||o)(t!=+t?t:n.ram[t],0,16384)}function o(n,t,e){return function(){do n[t]=g();while(++t<e);return[]}}function u(){n.model=n.pFF=n.halted=0,n.p7FFD=48,n.rom=null}function r(){return u(),d({bc:13,de:11,hl:9,ix:17,iy:15,bc_:5,de_:3,hl_:1,a:22,f:21,a_:8,f_:7,sp:23,i:0,r:20}),n.im=b[25],n.iff=4&b[19]?3:0,n.border=7&b[26],64&b[26]&&(n.ay=!0),[i(5),i(2),i(0),c]}function c(t){function e(t){return[[],n.ram[5],n.ram[2],n.ram[0]][t>>14][16383&t]}if(t>0)return[o(b=[],0,4),a];if(t){var i=n.sp;n.pc=e(i)|e(i+1)<<8,n.sp=i+2&65535}return t}function a(){d({pc:0}),n.model=1,n.p7FFD=e=b[2],(e&=7)&&(b=n.ram[0],n.ram[0]=n.ram[e],n.ram[e]=b);for(var t=[],e=0;8>e;e++)2!=e&&5!=e&&e!=(7&n.p7FFD)&&t.push(i(e));return t}function f(){u(),d({a:0,f:1,bc:2,hl:4,pc:6,sp:8,i:10,de:13,bc_:15,de_:17,hl_:19,a_:21,f_:22,iy:23,ix:25});var t=b[12],e=b[28];if(255==t&&(t=1),n.r=127&b[11]|t<<7&128,n.border=t>>1&7,n.halted=118==e,n.im=b[29],n.iff=!!b[27]|!!e<<1,b[29]>>6==1&&(n.joy=!0),!n.pc)return[o(b,30,32),s];if(32&t)var i=p();return n.ram=bytes(49152),[(i||o)(n.ram,0,49152)]}function s(){var t,e,i,u,r=b[30]|b[31]<<8,c=32+r;if(b.length<c)return[o(b,32,c),s];if(d({pc:32}),t=b[34],e=0,t>(24>r?2:3)&&14>t&&(n.p7FFD=b[35],e=9==t?5:1),n.model=e,(n.tc2048=14==(-2&t))&&(n.pFF=b[36]),t=b[37],1&t||(n.r=128&n.r|128*Math.random()),4&t)for(u=[],n.ay={idx:b[38],reg:u},i=0;16>i;i++)u[i]=b[i+39];n:if(r>=73&&b[29]>>6==2){for(u=[],i=0;10>i;i+=2){var a=b[63+i],f=b[64+i];if(a>7||f>31||!f||f-1&f)break n;f=8>f?f>>1:16+f>>3,u.push(a|f<<3)}n.joy=u}return[l]}function l(n){return n>0?[o(b=[],0,3),m]:n}function m(){var t,e,o=b[0]|b[1]<<8,u=b[2];if(o|u)return e=[[,2,0,,,5],[0,1,2,3,4,5,6,7]][n.model>0|0][u-3],e!=+e&&(e=bytes(16384),2>u&&(n.rom=e)),65535>o&&(t=p()),[i(e,t),l]}function d(t){for(var e in t){var i=t[e];n[e]=b[i],e.match(/.[a-z]/)&&(n[e]|=b[i+1]<<8)}}function p(){var n,t=0;return function(e,i,o){return function(){n:for(;;)switch(t){case 0:do if(n=g(),e[i]=n,++i==o)break n;while(237!=n);t--;case-1:if(n=g(),237!=n){if(e[i]=n,++i===o)break n;t=0;break}t--,i--;case-2:if(n=g(),!n){t=e.length-i;break}t--;case-3:var u=g();if(t=n,n=u,!t)break;default:do if(e[i]=n,--t,++i===o)break n;while(t)}return[]}}}function v(t){var e=b.length;if(t!==y){if(t)do b.push(g());while(--t);return[v]}for(;e&e-1;)e=b.push(255);for(;16384>e;)b=b.concat(b),e+=e;u(),n.rom=b,n.pc=n.im=n.iff=0}function h(t){function e(n,t){do r[i[c]>>3&7]++,c+=t;while(--n)}u();var i,r,c,a;for(i=n.ram[5],c=6912;16380>c;c++)i[c]=0;if(i[c++]=243,i[c++]=118,i[c++]=24,i[c]=252,n.pc=32764,n.halted=1,n.iff=n.border=n.model=0,t!==y){if(t)if(b[0]>=0){for(n.pFF=2,a=8192,c=0;768>c;c++)i[a++]=i[6144+c];i[a++]=b[0],t=[o(i,a,14335)]}else b[0]=g(),t=[h];return t}if(a=b[0],!(a>=0))for(r=[0,0,0,0,0,0,0,0],c=6911,e(63,-1),e(22,-32),e(31,1),e(22,32),c=a=0;8>c;c++)r[c]>r[a]&&(a=c);return n.border=7&a,[]}function g(){var n=t.data,e=t.data.length,i=t.pos;if(i>=e)throw y;return t.pos=i+1,n.charCodeAt?255&n.charCodeAt(i):n[i]}t.pos|=0;var b=[],k={sna:[r,o(b,0,27)],z80:[f,o(b,0,30)],rom:[v],scr:[h,o(n.ram[5],0,6912)]}[e];if(!k)throw"Unknown format";var y=[];return function(){try{for(var n;n=k.pop();){var e=n(t.data.length-t.pos||(t.eof?y:0));if(!e)break;k=k.concat(e.reverse())}}catch(n){if(n!==y)throw n;if(t.eof)throw"Unexpected end of file"}return n?k.push(n):void 0}}function u(n){function t(t){for(var e in t){var i=t[e];u[i]=255&n[e],e.match(/.[a-z]/)&&(u[i+1]=n[e]>>8)}}function e(t,e){i(t,n.ram[e],0)}function i(n,t,e){var i,o,u,a=e+16384,f="";do{for(i=t[e],o=1;t[++e]===i&&255>o;)o++;if(u=r(i),o>4||237==i&&o>1)f+="\xed\xed"+r(o)+u;else{do f+=u;while(--o);237==i&&a>e&&(f+=r(t[e++]))}}while(a>e);o=f.length,c+=r(255&o,o>>8,n)+f}var o,u=[];if(t({a:0,f:1,bc:2,hl:4,pc:32,sp:8,i:10,r:11,de:13,bc_:15,de_:17,hl_:19,a_:21,f_:22,iy:23,ix:25}),u[12]=n.r>>7&1|n.border<<1|32,o=n.iff,u[27]=1&o,u[28]=2&o&&(n.halted?118:1),u[29]=80|n.im,u[30]=23,o=n.model,u[34]=o?5==o?9:3:n.tc2048|n.pFF?14:0,u[35]=n.p7FFD,u[36]=0|n.pFF,o=3,n.ay){for(u[38]=n.ay.idx,o=0;16>o;o++)u[39+o]=n.ay.reg[o];o=7}u[37]=o,u.length=32+u[30];var r=String.fromCharCode,c=r.apply(0,u);if(n.model){var a,f=5|n.p7FFD>>2&2;for(e(f+3,f),a=0;8>a;a++)a!=f&&e(a+3,a)}else e(8,5),e(4,2),e(5,0);return(u=n.rom)&&i(1,u,0),c}function r(n){function t(n){var t,u,r,c,a,f=n.pFE,s=16384;if(f!=c&&(q=f),f=n.border,t=q,f!=c&&(q=248&t|f),a=7&(t^q),yn=7&q,"rom"in n&&(M=n.rom),f=n.model,t=n.p7FFD,t!=+t&&(t=H),f!=c&&(f=5==f?f:+!!f,_=-26&_|f>0|(5>f?24:0),z=[[69888,14335,224,32],[70908,14361,228,32],,,,[71680,17989,224,36]][f],T=z[2],D=191*T+126,L=F.rom128[1],1&_||(L=F.rom48k,I!=R[0]&&e(R[0]=bytes(s),0,I,0,s),t=48)),a|=8&(t^H),o(t),f=n.tc2048,t=n.pFF,f!=c&&(_=-5&_|f<<2,f||(t|=0)),t==+t&&(j=t),f=n.cont,f!=c&&(_&=-9,O&=-16,f&&(_|=8,O|=2|(1&H)<<3)),f=n.fbus,f!=c&&(_=-17&_|!!f<<4),f=n.joy,f!=c&&(f?F.joy&=255:F.joy=c),f=n.ram)if(a=1,r=f.length,r>8)e(A,0,f,0,s),e(N,0,f,s,s),e(I,0,f,s+s,s);else for(;r;)(u=f[--r])&&R[r]!=u&&e(R[r],0,u,0,s);if(f=n.ay,f==c&&(f=n.model),""===f&&(f=!!Cn,Cn=c),f){if(Cn||y(),f.reg)for(t=0;15>t;t++)f.reg[t]!=c&&x(t,0|f.reg[t]);t=f.idx,t!=c&&(Cn.idx=15&t)}else f!=c&&(Cn=c);f=n.time,f==+f&&(F.time=f-z[1]),a&&V&&i(2),F.cpu.setState(n)}function e(n,t,e,i,o){do n[t++]=0|e[i++];while(--o)}function i(n){G||s(),pn=(1&j)<<13,dn=0,hn=X*en,vn=X*(K+32+K)+K-1;var t=-T*X-4*K+4;bn=-K,kn=-X,gn=t;var e=z;if(1&n?(F.int=4&_&&64&j?-1:255,F.time_limit=e[3]-e[1],F.cpu.execute(),F.int=-1,F.time_limit=e[0]-e[1],F.cpu.execute()):F.time+=e[0],2&n&&(a(F.time),yn!=wn)){var i=gn;f(F.time),i==t&&(wn=yn)}F.time-=z[0],mn&&2&n&&h(mn)}function o(n){H=n,I=R[7&n],O=8&_?226|n<<3&8:224,U=R[5|n>>2&2],E=16&n?M||L:F.rom128[0]}function u(n){n+=F.time,0>n||n>=D||(n%=T,126>n&&(n=6-(7&n))>0&&(F.time+=n))}function r(n){var t,e,i=B;if(!(0>=i+n||(t=D-i,0>t))){if(t%=T,t>126){if(n-=t-126,0>=n)return;i=6,e=15}else{if(e=t>>3,t&=7,7==t&&(t--,!--n))return;i=t}n=n-1>>1,n>e&&(n=e),F.time+=i+6*n}}function c(n){var t=F.time-B,e=1&n;t>0&&r(t),8&_?n>>14^1?(e||u(1),B=99999):(B=F.time,r(1+e<<1),B=F.time+4):B=99999}function a(n){if(!(dn>n)){var t,e,i=pn,o=dn,u=vn,r=hn,c=1<<(i>>5&7|i>>8&24);e=3&j,t=2>e?(-256&i)-(i>>3&768)-6144:3^e&&-8192;do if(e=W[U[i-t]]|U[i++],P[++u]!==e&&(P[u]=e,tn(u,r,e),mn|=c),e=W[U[i-t]]|U[i++],P[++u]!==e&&(P[u]=e,tn(u,r,e),mn|=c),o+=8,!(31&i)){if(o+=T-128,u+=2*K,r+=en,i+=224,2&j){if(1792&i)continue;if(i-=2016,c<<=1,224&i)continue}else{if(t+=256,1792&i)continue;if(i-=2016,t-=2048,c<<=1,224&i)continue;t+=1792}if(i+=1792,(8191&i)>=6144){o=99999;break}}while(n>=o);pn=i,dn=o,vn=u,hn=r}}function f(n){var t=gn;if(!(t>n)){wn=-1;var e=bn,i=kn,o=en*(i+X),u=K+(K+32+K)*X+(K+32+K)*i+e,r=W[yn<<3];do if(P[u]!==r&&(P[u]=r,tn(u,o,r),mn=-1),u++,t+=4,!++e&&i>=0&&192>i)u+=e=32,t+=128;else if(e>=32+K){if(e=-K,++i==8*(24+X)){t=99999;break}t+=T-4*(K+32+K),o+=en}while(n>=t);bn=e,kn=i,gn=t}}function s(){var n,t=V,e=Q,i=e*Y;for(G=t.createImageData(J,i),Z=G.data,n=Z.length-1;n>0;n-=4)Z[n]=255;for(nn=[[0,13178133,2171338,13313739,2935596,13421615,3526093,13487565,0,16456475,2697724,16527356,3669303,16711227,4325375,16777215],[65793,13637399,2302929,13773010,3068718,13882162,3658964,13948116,65793,16718876,2829311,16724479,3800889,16777022,4521983,16777215,0,12719124,2039747,12788675,2737193,12961069,3327429,13027014,0,15997209,2500343,16264440,3471924,16513848,4128253,16711422]][--e],W=[],n=0;128>n;n++)W[128|n]=W[n]=(n<<1&240|n>>3&8|7&n)<<8;if(en=4*e*J,Z.buffer){for(en=e*J,Z=new Uint32Array(Z.buffer),n=nn.length;--n>=0;)nn[n]|=-1<<24;e+=2}tn=[l,d,m,p][e]}function l(n,t,e){var i,o,u=Z;o=nn[e>>12],i=nn[e>>8&15]^o,e^=e>>1&127,n*=32;do 128&e&&(o^=i),e<<=1,u[n]=255&o,u[n+1]=o>>8&255,u[n+2]=o>>16;while(31&(n+=4))}function m(n,t,e){var i,o,u=Z;i=nn[e>>12],o=nn[e>>8&15],n*=8;do u[n++]=128&e?o:i,e<<=1;while(7&n)}function d(n,t,e){var i,o,u,r,c=Z;o=e>>12,r=e>>8&15,i=nn[o],u=nn[r]^i,o=nn[o+16],r=nn[r+16]^o,e^=e>>1&127,t+=32*n;do 128&e&&(i^=u,o^=r),e<<=1,c[t]=255&i,c[t+1]=i>>8&255,c[t+2]=i>>16,c[t+4*J]=255&o,c[t+4*J+1]=o>>8&255,c[t+4*J+2]=o>>16;while(31&(t+=4))}function p(n,t,e){var i,o,u,r,c=Z;o=e>>12,r=e>>8&15,i=nn[o],u=nn[r]^i,o=nn[o+16],r=nn[r+16]^o,e^=e>>1&127,t+=8*n;do 128&e&&(i^=u,o^=r),e<<=1,c[t]=i,c[t+J]=o;while(7&++t)}function v(){G||s();var n,t,e=0,i=0;for(t=0;192+2*X>t;t++){for(n=0;32+2*K>n;n++,e++)tn(e,i,P[e]);i+=en}h(-1)}function h(n){function t(n){var t=0;return n>65535&&(n>>=t=16),n>255&&(n>>=8,t+=8),n>15&&(n>>=4,t+=4),t+(-21936>>2*n&3)}var e=V,i=e.canvas,o=i.width-J>>1,u=i.height-Q*Y>>1;if(mn=0,0>n)return e.putImageData(G,o,u);var r=t(n),c=t(n^n-1);e.putImageData(G,o,u,8*K-1,Q*(8*c+X)-1,258,8*Q*(r-c+1)+2)}function g(){var n=q;return 16&n?8&n?sn:fn:0}function b(n,t){var e,i,o=cn;if(o){for(e=xn*t/un,i=an,o[i]+=e,o[i+1]+=t-e,n=xn-rn*n;0>n;)n+=un,i++;xn=n,an=i}}function k(n){var t,e,i,o=$n;if(e=g(),i=e-Sn,Sn=e,Cn){for(t=Fn,t||(i+=S(Cn),t+=16),t+=o;n>t;)e=S(Cn),e&&(b(t-o,i),o=t,i=e),t+=16;Fn=t-n}b(n-o,i),$n=n}function y(){Cn={idx:0,reg:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],volt:[0],avol:0,bvol:0,cvol:0,mix:0,gen:0,aper:0,bper:0,cper:0,nper:0,eper:0,dis:0,ech:0,ekeep:0,ealt:0,eattack:0,estep:0,ecnt:0,noise:1},w()}function w(){var n=sn,t=Cn.volt,e=15;t[e]=n;do t[--e]=n*[0,.014,.02,.029,.042,.062,.085,.137,.169,.265,.353,.45,.57,.687,.848][e];while(e>1);for(e=8;11>e;e++)x(e,Cn.reg[e]);Cn.level=C()}function x(n,t){switch(n){case 0:Cn.aper=3840&Cn.aper|t;break;case 1:Cn.aper=255&Cn.aper|(t&=15)<<8;break;case 2:Cn.bper=3840&Cn.bper|t;break;case 3:Cn.bper=255&Cn.bper|(t&=15)<<8;break;case 4:Cn.cper=3840&Cn.cper|t;break;case 5:Cn.cper=255&Cn.cper|(t&=15)<<8;break;case 6:Cn.nper=t&=31;break;case 7:Cn.mix=~(t|Cn.dis);break;case 8:case 9:case 10:var e=t&=31,i=9<<n-8;t?16>t?(Cn.dis&=i=~i,Cn.ech&=i):(Cn.dis&=~i,Cn.ech|=i,e=Cn.estep^Cn.eattack):(Cn.dis|=i,Cn.ech&=~i),Cn.mix=~(Cn.reg[7]|Cn.dis),e=Cn.volt[e],9>n?Cn.avol=e:n>9?Cn.cvol=e:Cn.bvol=e;break;case 11:Cn.eper=65280&Cn.eper|t;break;case 12:Cn.eper=255&Cn.eper|t<<8;break;case 13:t&=15,8>t&&(t=4>t?1:7),Cn.ekeep=1&t?1:-1,Cn.ealt=t+1&2?15:0,Cn.eattack=4&t?15:0,Cn.estep=15,Cn.ecnt=-1,$()}Cn.reg[n]=t}function $(){var n,t=Cn.ech;t&&(n=Cn.volt[Cn.estep^Cn.eattack],1&t&&(Cn.avol=n),2&t&&(Cn.bvol=n),4&t&&(Cn.cvol=n))}function S(n){var t,e=0;return--n.acnt&n.aper||(n.acnt=-1,e^=1),--n.bcnt&n.bper||(n.bcnt=-1,e^=2),--n.ccnt&n.cper||(n.ccnt=-1,e^=4),(n.div16^=1)&&(--n.ncnt&n.nper||(n.ncnt=-1,t=n.noise,1&t&&(e^=56,t^=163840),n.noise=t>>1),--n.ecnt&n.eper||(n.ecnt=-1,n.ekeep&&(n.estep||(n.eattack^=n.ealt,n.ekeep>>=1,n.estep=16),n.estep--,n.ech&&($(),e|=256)))),n.gen^=e,t=0,e&n.mix&&(t=n.level-(n.level=C())),t}function C(){var n=Cn.mix&Cn.gen;return(9&n?0:Cn.avol)+(18&n?0:Cn.bvol)+(36&n?0:Cn.cvol)}var F=this;F.cpu=new n(F),F.devs=[],F.keyboard=[255,255,255,255,255,255,255,255];var _=24;F.init=function(){R=[];for(var n=0;8>n;n++)R[n]=bytes(16384);for(E=rom=L,A=R[5],N=R[2],I=R[0],O=226,U=A,t({model:0}),F.time=-z[1],n=6144;6912>n;)A[n++]=7;P=[],n=J*Y/8;do P[--n]=0;while(n);V&&v()},F.reset=function(){F.cpu.reset(),yn=0,o(1&_?0:48),j=0;var n,t,e=F.time,i=F.devs,u=i.length;for(n=0;u>n;n++)t=i[n],t.reset&&t.reset(e)},F.canvas=function(n,t){G=null,V=n.getContext("2d"),Q=t||1,P&&v()},F.getState=function(n){var t,i,o,u=F.cpu.getState(),r=16384;if(u.pFE=q,u.border=yn,u.p7FFD=H,u.model=1&_&&(8&_?1:5),u.tc2048=!!(4&_),u.cont=!!(8&_),u.fbus=!!(16&_),u.joy=F.joy!=o,u.pFF=j,u.ay=Cn&&{idx:Cn.idx,reg:Cn.reg.slice()},u.time=F.time+z[1],1==n)t=bytes(49152),e(t,0,A,0,r),e(t,r,N,0,r),e(t,r+r,I,0,r);else for(t=[],i=0;8>i;i++)t[i]=R[i],n>1&&e(t[i]=bytes(r),0,R[i],0,r);return u.ram=t,M&&(u.rom=M),u},F.setState=t;var z,T,D;F.frame=function(n){if(!--ln){ln=16;for(var t=128;256>t;t++){var e=W[t];e=e<<4&61440|e>>4&3840,W[t]=e}}for(var o=F.time,u=z[0],t=0,r=F.devs,c=r.length;c>t;t++){var a=r[t];a.frame&&a.frame(u,o,n)}var f=cn;if(4&n||(cn=null),i(n),on&&4&n){var s=new Float32Array(on.hz/50+32|0);f&&(k(u+o),on.play(f.subarray(0,an)),s[0]=f[an]||0,s[1]=f[an+1]||0),f=s,un=50*u,$n=o,an=0}cn=f};var E,A,N,I,R,L,M,O,U;F.time=F.time_limit=0,F.m1=function(n,t){var e,i;32768>n?16384>n?(e=E,i=1):(e=A,i=2):49152>n?(e=N,i=4):(e=I,i=8);var o=F.time-B;return o>0&&r(o),O&i&&u(0),B=O&1<<(t>>14)?F.time+4:99999,e[16383&n]},F.get=function(n){var t,e;32768>n?16384>n?(t=E,e=1):(t=A,e=2):49152>n?(t=N,e=4):(t=I,e=8);var i=F.time-B;return i>0&&r(i),B=99999,O&e&&(u(0),B=F.time+3),t[16383&n]},F.put=function(n,t){var e,i=O;32768>n?16384>n?(e=E,i&=17):(e=A,i&=34):49152>n?(e=N,i&=68):(e=I,i&=136);var o=F.time-B;o>0&&r(o),B=99999,i&&(15&i&&(u(0),B=F.time+3),n&=16383,e[n]!==t&&(e===U&&a(F.time),e[n]=t))},F.get16=function(n){var t=16383&n;if(16383==t){var e=F.get(n);return F.time+=3,e|=F.get(n+1&65535)<<8,F.time-=3,e}var i,o;32768>n?16384>n?(i=E,o=1):(i=A,o=2):49152>n?(i=N,o=4):(i=I,o=8);var c=F.time-B;return c>0&&r(c),B=99999,O&o&&(u(0),u(3),B=F.time+6),i[t]|i[t+1]<<8};var q=0,H=48,j=0;F.inp=function(n){c(n);var t,e,i,u,r=65535,f=F.time,s=F.devs,l=s.length;for(31==(255&n)&&null!=(t=F.joy)&&(r=t),i=0;l>i;i++)u=s[i],(n&u.imask)==u.iport&&(r&=u.inp(n,f));if(256>r)return r;if(t=4&_?0:255,1&n){if(Cn&&49152==(49154&n))t=Cn.reg[Cn.idx];else if(!(255&~n)&&4&_)t=j;else if(f>=0&&16&_){var m,d=f/T;f%=T,192>d&&124>f&&!(4&f)&&(m=f>>1&1|f>>2,m+=1&f?6144|d<<2&992:6144&d|d<<2&224|d<<8&1792,t=U[m])}}else for(t=q<<2&64|160&t|31,e=n>>8^255,i=0;e;i++)1&e&&(t&=F.keyboard[i]),e>>=1;return r&=t|r>>8^255,32770&n||32&H||(8&(H^r)&&a(f),o(r)),r},F.out=function(n,t){c(n);var e,i,u=F.time,r=F.devs,s=r.length;for(e=0;s>e;e++){var l=r[e];(n&l.omask)==l.oport&&l.out(n,t,u)}if(1&n||(i=7&t,i!=yn&&(f(u),yn=i),24&(q^t)&&cn&&k(u+(t>>1&8^8)),q=t),!(2&n))if(32768>n){if(32&H)return;8&(H^t)&&a(u),o(t)}else Cn&&(49152>n?(k(u),x(Cn.idx,t),b(0,Cn.level-(Cn.level=C()))):Cn.idx=15&t);!(255&~n)&&4&_&&(a(u),pn=8191&pn|(1&t)<<13,j=t)},F.halt=function(n,t){return n};var B,K=4,X=28,J=8*(K+32+K),Y=X+192+X;F.dim=[J,Y];var W,P,V,G,Z,Q,nn,tn,en,on,un,rn,cn,an,fn,sn,ln=16,mn=0,dn=0,pn=0,vn=0,hn=0,gn=0,bn=0,kn=0,yn=0,wn=-1,xn=0,$n=0,Sn=0;F.audio=function(n){on=n,n&&(rn=n.hz)},(F.volume=function(n){n*=n,sn=n,fn=.93*n,Cn&&w(),Sn=g()})(.5);var Cn,Fn=0;F.command=function(n){function t(n,t){[,A,N,I][n>>14][16383&n]=t}function e(n,e){t(n,255&e),t(n+1,e>>8)}function i(n,e,i,o){for(;o-- >0;)t(n++,e[i++])}var u=F.rom48k;o(32&H|16);var r={i:63,border:7,rom:null,ay:""},c=16384;do t(c++,0);while(22528>c);do t(c++,56);while(23296>c);do t(c++,0);while(65536>c);e(23732,--c),c-=167,i(c,u,15880,168),e(23675,c--),t(23608,64),e(23730,c),e(23606,15360),t(c--,62),r.sp=c,e(23613,c-2),r.iy=23610,r.im=1,r.iff=3,e(23631,23734),i(23734,u,5551,21),c=23754,e(23639,c++),e(23635,c),e(23627,c),t(c++,128),e(23641,c);for(var a=0;a<n.length;a++)t(c++,n.charCodeAt(a));e(c,32781),c+=2,e(23649,c),e(23651,c),e(23653,c),t(23693,56),t(23695,56),t(23624,56),e(23561,1315),t(23552,255),t(23556,255),i(23568,u,5574,14),e(23688,6177),t(23659,2),e(23656,23698),t(23611,12),r.pc=4788,t(23672,256*Math.random()|0),F.setState(r)}}function c(n){function t(){var n=168&Q|Q>>8&1|!nn<<6,t=tn,e=en,i=e>>8,o=nn^t;return n|=2&i,n|=16&(o^e^i),t=256&t?154020>>(15&(nn^nn>>4)):(o&(e^nn))>>5,n|4&t}function e(n){nn=64&~n,Q=n|=n<<8,tn=255&(en=-129&n|(4&n)<<5)}function i(n){e(255&n),Z=n>>8}function o(n){xn=65280&xn|n,$n=127&n}function u(n){un=n>>8,rn=255&n}function r(n){cn=n>>8,an=255&n}function c(){var n;n=gn,gn=un,un=n,n=bn,bn=rn,rn=n,n=kn,kn=cn,cn=n,n=yn,yn=an,an=n,n=wn,wn=fn,fn=n}function a(){var n=mn;mn=Z,Z=n,n=dn,dn=Q,Q=n,n=pn,pn=nn,nn=n,n=vn,vn=tn,tn=n,n=hn,hn=en,en=n}function f(){}function s(t){n.time++,n.put(on-1&65535,t>>8),n.time+=3,n.put(on=on-2&65535,255&t),n.time+=3}function l(){var t=n.get16(on);return on=on+2&65535,n.time+=6,t}function m(n){var t=(tn=Z)-n;en=~n,Q=384&t|40&n,nn=255&t}function d(n){return Q=256&Q|(nn=n=(tn=n)+(en=1)&255),n}function p(n){return Q=256&Q|(nn=n=(tn=n)+(en=-1)&255),n}function v(n){Q=256&Q|(nn=n),tn=256|n,en=0}function h(n){Q=215&Q|296&n,en&=128,tn=384&tn|16&nn,Z=255&n}function g(t,e){var i=t+e;return Q=128&Q|i>>8&296,tn&=-17,en=128&en|16&((i^t^e)>>8^nn),_n=t+1,n.time+=7,65535&i}function b(){var t=n.get(G);return G=G+1&65535,n.time+=3,t}function k(){var t=n.get16(G);return G=G+2&65535,n.time+=6,t}function y(n){tn&=-17,en=128&en|16&(n>>4^nn),Q=256^n|128&Q|40&Z}function w(){Q=384&Q|40&(Z^=255),en|=-129,tn=384&tn|16&~nn}function x(){var n=16&(nn^tn^en^en>>8),t=0;(Z|256&Q)>153&&(t=352),(15&Z|n)>9&&(t+=6),tn=256|Z,512&en?(Z-=t,en=~t):Z+=en=t,Q=(nn=Z&=255)|256&t}function $(n){var t=_n=k();n&&(G=t)}function S(){_n=G=G+(128^n.get(G))-127&65535,n.time+=8}function C(n){var t=_n=k();n&&(s(G),G=t)}function F(){_n=G=n.get16(on),on=on+2&65535,n.time+=6}function _(){Fn=!0;var t=n.time_limit-n.time+3>>2;t>0&&(t=n.halt(t,xn|$n),$n=$n+t&127,n.time+=4*t)}function z(t){var e,i,o,u;n:for(;;){switch(t){case 221:case 253:break;case 243:Cn=0;break;case 251:Cn=3;break;default:zn[t]();break n}if(i=t,t=n.m1(G,xn|($n=$n+1&127)),G=G+1&65535,n.time+=4,4&i&&(e=Tn[t])){o=e(221==i?sn:ln),o!=u&&(221==i?sn=o:ln=o);break}}1&Cn&&n.int>=0&&n.time<n.time_limit&&A()}function T(){var t=Dn[n.m1(G,xn|($n=$n+1&127))];G=G+1&65535,n.time+=4,t&&t()}function D(){var t,e,i;t=n.m1(G,xn|($n=$n+1&127)),G=G+1&65535,n.time+=4,i=t>>3,e=7&i,i=8&i|7&t,128>t?En[i](e):An[i](1<<e)}function E(t){var e,i,o,u;switch(e=_n=t+(128^n.get(G))-128&65535,n.time+=3,i=n.get(G+1&65535),G=G+2&65535,n.time+=5,o=n.get(e),n.time+=4,u=i>>3&7,192&i){case 0:o=P(u,o);break;case 64:return V(u,o),void(Q=384&Q|e>>8&40);case 128:o&=~(1<<u);break;case 192:o|=1<<u}switch(n.put(e,o),n.time+=3,7&i){case 0:un=o;break;case 1:rn=o;break;case 2:cn=o;break;case 3:an=o;break;case 4:fn=255&fn|o<<8;break;case 5:fn=65280&fn|o;break;case 7:Z=o}}function A(){var t,e=n.int;$n=$n+1&127,Cn=0,Fn=!1,n.time+=6,Sn?(s(G),t=56,Sn>1&&(t=n.get16(65280&xn|e),n.time+=6),_n=G=t):zn[e]()}function N(t){var e=n.get(G);return G=G+1&65535,n.time+=8,_n=t+(128^e)-128&65535}function I(t){var e=n.get(G);return G=G+1&65535,n.time+=8,e=n.get(_n=t+(128^e)-128&65535),n.time+=3,e}function R(t,e){var i=fn+t+(Q>>8&1^e);_n=fn+1,Q=i>>8,tn=fn>>8,en=t>>8,fn=i=65535&i,nn=i>>8|i<<8,n.time+=7}function L(){var t=n.get(fn)|Z<<8;n.time+=7,v(Z=240&Z|15&t),n.put(fn,t>>4&255),_n=fn+1,n.time+=3}function M(){var t=n.get(fn)<<4|15&Z;n.time+=7,v(Z=240&Z|t>>8),n.put(fn,255&t),_n=fn+1,n.time+=3}function O(t){Q=256&Q|(Z=t),nn=+!!t,tn=en=Cn<<6&128,n.time++}function U(){var t=un<<8|rn,e=n.inp(t);return _n=t+1,v(e),n.time+=4,e}function q(t){var e=un<<8|rn;_n=e+1,n.out(e,t),n.time+=4}function H(t,e){var i,o;o=n.get(i=fn),fn=i+t&65535,n.time+=3,n.put(i=cn<<8|an,o),i+=t,cn=i>>8&255,an=255&i,n.time+=5,nn&&(nn=1),o+=Z,Q=384&Q|8&o|o<<4&32,o=0,--rn<0&&(un=un-1&(rn=255)),un|rn&&(e&&(n.time+=5,_n=(G=G-2&65535)+1),o=128),tn=en=o}function j(t,e){var i,o,u;u=Z-(o=n.get(i=fn))&255,_n+=t,fn=i+t&65535,n.time+=8,nn=127&u|u>>7,en=~(128|o),tn=127&Z,--rn<0&&(un=un-1&(rn=255)),un|rn&&(tn|=128,en|=128,e&&u&&(_n=(G=G-2&65535)+1,n.time+=5)),Q=256&Q|128&u,16&(u^o^Z)&&u--,Q|=u<<4&32|8&u}function B(t){var e,i,o,u,r=t>>2;e=fn+r&65535,i=un<<8|rn,n.time++,1&t?(o=n.get(fn),n.time+=3,i=i-256&65535,_n=i+r,n.out(i,o),n.time+=4,r=e):(o=n.inp(i),n.time+=4,_n=i+r,i=i-256&65535,n.put(fn,o),n.time+=3,r+=i),r=(255&r)+o,fn=e,un=i>>=8,2&t&&i&&(n.time+=5,G=G-2&65535),u=7&r^i,Q=i|(r&=256),tn=128^(nn=i),u=4928640>>(15&(u^u>>4)),en=128&(u^i)|r>>4|(128&o)<<2}function K(){Z=nn=255&(Q=(en=~Z)+1),tn=0}function X(){Cn|=Cn>>1,F()}function J(){Sn=0}function Y(){Sn=1}function W(){Sn=2}function P(n,t){switch(n){case 0:t=257*t>>7;break;case 1:t=t>>1|((1&t)+1^1)<<7;break;case 2:t=t<<1|Q>>8&1;break;case 3:t=(513*t|256&Q)>>1;break;case 4:t<<=1;break;case 5:t=(513*t+128^128)>>1;break;case 6:t=t<<1|1;break;case 7:t=513*t>>1}return tn=256|(nn=t=255&(Q=t)),en=0,t}function V(n,t){Q=256&Q|40&t|(t&=1<<n),tn=~(nn=t),en=0}this.env=n;var G,Z,Q,nn,tn,en,on,un,rn,cn,an,fn,sn,ln,mn,dn,pn,vn,hn,gn,bn,kn,yn,wn,xn,$n,Sn,Cn,Fn,_n;G=xn=$n=Sn=Cn=0,on=sn=ln=fn=wn=65535,Z=un=rn=cn=an=mn=gn=bn=kn=yn=255,Q=nn=tn=en=dn=pn=vn=hn=0,Fn=!1,this.getState=function(){var n={pc:G,a:Z,f:t(),sp:on,bc:un<<8|rn,de:cn<<8|an,hl:fn,ix:sn,iy:ln,bc_:gn<<8|bn,de_:kn<<8|yn,hl_:wn,a_:mn,r:128&xn|$n,i:xn>>8,im:Sn,iff:Cn,halted:Fn};return a(),n.f_=t(),a(),n},this.setState=function(n){"pc"in n&&(G=n.pc),"a"in n&&(Z=n.a),"f"in n&&e(n.f),"sp"in n&&(on=n.sp),"bc"in n&&u(n.bc),"de"in n&&r(n.de),"hl"in n&&(fn=n.hl),"ix"in n&&(sn=n.ix),"iy"in n&&(ln=n.iy),c(),a(),"bc_"in n&&u(n.bc_),"de_"in n&&r(n.de_),"hl_"in n&&(fn=n.hl_),"a_"in n&&(Z=n.a_),"f_"in n&&e(n.f_),c(),a(),"r"in n&&o(n.r),"i"in n&&(xn=255&xn|n.i<<8),"im"in n&&(Sn=3&n.im),"iff"in n&&(Cn=n.iff),"halted"in n&&(Fn=!!n.halted)},this.execute=function(){if(!(n.time>=n.time_limit)){if(1&Cn&&n.int>=0&&A(),Fn)return _();do{var t=n.m1(G,xn|($n=$n+1&127));G=G+1&65535,n.time+=4,zn[t]()}while(n.time<n.time_limit)}},this.nmi=function(){Cn&=2,Fn=!1,s(G),n.time+=4,G=102},this.reset=function(){Fn=!1,G=xn=$n=Sn=Cn=0};var zn=[f,function(){var n=k();un=n>>8,rn=255&n},function(){var t=un<<8|rn;_n=t+1&255|Z<<8,n.put(t,Z),n.time+=3},function(){256===++rn&&(un=un+1&255,rn=0),n.time+=2},function(){un=d(un)},function(){un=p(un)},function(){un=b()},function(){h(257*Z>>7)},a,function(){fn=g(fn,un<<8|rn)},function(){var t=un<<8|rn;_n=t+1,Z=n.get(t),n.time+=3},function(){--rn<0&&(un=un-1&(rn=255)),n.time+=2},function(){rn=d(rn)},function(){rn=p(rn)},function(){rn=b()},function(){h(Z>>1|((1&Z)+1^1)<<7)},function(){var t,e;n.time++,e=n.get(t=G),t++,n.time+=3,(un=un-1&255)&&(n.time+=5,_n=t+=(128^e)-128),G=65535&t},function(){var n=k();cn=n>>8,an=255&n},function(){var t=cn<<8|an;_n=t+1&255|Z<<8,n.put(t,Z),n.time+=3},function(){256===++an&&(cn=cn+1&255,an=0),n.time+=2},function(){cn=d(cn)},function(){cn=p(cn)},function(){cn=b()},function(){h(Z<<1|Q>>8&1)},S,function(){fn=g(fn,cn<<8|an)},function(){var t=cn<<8|an;_n=t+1,Z=n.get(t),n.time+=3},function(){--an<0&&(cn=cn-1&(an=255)),n.time+=2},function(){an=d(an)},function(){an=p(an)},function(){an=b()},function(){h((513*Z|256&Q)>>1)},function(){nn?S():b()},function(){fn=k()},function(){var t=k();n.put(t,255&fn),n.time+=3,n.put(_n=t+1&65535,fn>>8),n.time+=3},function(){fn=fn+1&65535,n.time+=2},function(){fn=255&fn|d(fn>>8)<<8},function(){fn=255&fn|p(fn>>8)<<8},function(){fn=255&fn|b()<<8},x,function(){nn?b():S()},function(){fn=g(fn,fn)},function(){var t=k();_n=t+1,fn=n.get16(t),n.time+=6},function(){fn=fn-1&65535,n.time+=2},function(){fn=-256&fn|d(255&fn)},function(){fn=-256&fn|p(255&fn)},function(){fn=-256&fn|b()},w,function(){256&Q?b():S()},function(){on=k()},function(){var t=k();_n=t+1&255|Z<<8,n.put(t,Z),n.time+=3},function(){on=on+1&65535,n.time+=2},function(){var t=d(n.get(fn));n.time+=4,n.put(fn,t),n.time+=3},function(){var t=p(n.get(fn));n.time+=4,n.put(fn,t),n.time+=3},function(){n.put(fn,b()),n.time+=3},function(){y(0)},function(){256&Q?S():b()},function(){fn=g(fn,on)},function(){var t=k();_n=t+1,Z=n.get(t),n.time+=3},function(){on=on-1&65535,n.time+=2},function(){Z=d(Z)},function(){Z=p(Z)},function(){Z=b()},function(){y(256&Q)},f,function(){un=rn},function(){un=cn},function(){un=an},function(){un=fn>>8},function(){un=255&fn},function(){un=n.get(fn),n.time+=3},function(){un=Z},function(){rn=un},f,function(){rn=cn},function(){rn=an},function(){rn=fn>>8},function(){rn=255&fn},function(){rn=n.get(fn),n.time+=3},function(){rn=Z},function(){cn=un},function(){cn=rn},f,function(){cn=an},function(){cn=fn>>8},function(){cn=255&fn},function(){cn=n.get(fn),n.time+=3},function(){cn=Z},function(){an=un},function(){an=rn},function(){an=cn},f,function(){an=fn>>8},function(){an=255&fn},function(){an=n.get(fn),n.time+=3},function(){an=Z},function(){fn=255&fn|un<<8},function(){fn=255&fn|rn<<8},function(){fn=255&fn|cn<<8},function(){fn=255&fn|an<<8},f,function(){fn=255&fn|(255&fn)<<8},function(){fn=255&fn|n.get(fn)<<8,n.time+=3},function(){fn=255&fn|Z<<8},function(){fn=-256&fn|un},function(){fn=-256&fn|rn},function(){fn=-256&fn|cn},function(){fn=-256&fn|an},function(){fn=-256&fn|fn>>8},f,function(){fn=-256&fn|n.get(fn),n.time+=3},function(){fn=-256&fn|Z},function(){n.put(fn,un),n.time+=3},function(){n.put(fn,rn),n.time+=3},function(){n.put(fn,cn),n.time+=3},function(){n.put(fn,an),n.time+=3},function(){n.put(fn,fn>>8),n.time+=3},function(){n.put(fn,255&fn),n.time+=3},_,function(){n.put(fn,Z),n.time+=3},function(){Z=un},function(){Z=rn},function(){Z=cn},function(){Z=an},function(){Z=fn>>8},function(){Z=255&fn},function(){Z=n.get(fn),n.time+=3},f,function(){Z=nn=255&(Q=(tn=Z)+(en=un))},function(){Z=nn=255&(Q=(tn=Z)+(en=rn))},function(){Z=nn=255&(Q=(tn=Z)+(en=cn))},function(){Z=nn=255&(Q=(tn=Z)+(en=an))},function(){Z=nn=255&(Q=(tn=Z)+(en=fn>>8))},function(){Z=nn=255&(Q=(tn=Z)+(en=255&fn))},function(){Z=nn=255&(Q=(tn=Z)+(en=n.get(fn))),n.time+=3},function(){Z=nn=255&(Q=2*(tn=en=Z))},function(){Z=nn=255&(Q=(tn=Z)+(en=un)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=rn)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=cn)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=an)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=fn>>8)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=255&fn)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=n.get(fn))+(Q>>8&1)),n.time+=3},function(){Z=nn=255&(Q=2*(tn=en=Z)+(Q>>8&1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~un)+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~rn)+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~cn)+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~an)+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~(fn>>8))+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~(255&fn))+1)},function(){Z=nn=255&(Q=(tn=Z)+(en=~n.get(fn))+1),n.time+=3},function(){en=~(tn=Z),Z=nn=Q=0},function(){Z=nn=255&(Q=(tn=Z)+(en=~un)+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~rn)+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~cn)+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~an)+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~(fn>>8))+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~(255&fn))+(Q>>8&1^1))},function(){Z=nn=255&(Q=(tn=Z)+(en=~n.get(fn))+(Q>>8&1^1)),n.time+=3},function(){en=~(tn=Z),Z=nn=255&(Q=(Q>>8&1^1)-1)},function(){tn=~(Z=Q=nn=Z&un),en=0},function(){tn=~(Z=Q=nn=Z&rn),en=0},function(){tn=~(Z=Q=nn=Z&cn),en=0},function(){tn=~(Z=Q=nn=Z&an),en=0},function(){tn=~(Z=Q=nn=Z&fn>>8),en=0},function(){tn=~(Z=Q=nn=Z&fn&255),en=0},function(){tn=~(Z=Q=nn=Z&n.get(fn)),en=0,n.time+=3},function(){tn=~(Q=nn=Z),en=0},function(){tn=256|(Z=Q=nn=Z^un),en=0},function(){tn=256|(Z=Q=nn=Z^rn),en=0},function(){tn=256|(Z=Q=nn=Z^cn),en=0},function(){tn=256|(Z=Q=nn=Z^an),en=0},function(){tn=256|(Z=Q=nn=Z^fn>>8),en=0},function(){tn=256|(Z=Q=nn=Z^255&fn),en=0},function(){tn=256|(Z=Q=nn=Z^n.get(fn)),en=0,n.time+=3},function(){Z=Q=nn=en=0,tn=256},function(){tn=256|(Z=Q=nn=Z|un),en=0},function(){tn=256|(Z=Q=nn=Z|rn),en=0},function(){tn=256|(Z=Q=nn=Z|cn),en=0},function(){tn=256|(Z=Q=nn=Z|an),en=0},function(){tn=256|(Z=Q=nn=Z|fn>>8),en=0},function(){tn=256|(Z=Q=nn=Z|255&fn),en=0},function(){tn=256|(Z=Q=nn=Z|n.get(fn)),en=0,n.time+=3},function(){tn=256|(Q=nn=Z),en=0},function(){m(un)},function(){m(rn)},function(){m(cn)},function(){m(an)},function(){m(fn>>8)},function(){m(255&fn)},function(){m(n.get(fn)),n.time+=3},function(){m(Z)},function(){n.time++,nn&&F()},function(){var n=l();un=n>>8,rn=255&n},function(){$(nn)},function(){_n=G=k()},function(){C(nn)},function(){s(un<<8|rn)},function(){Z=nn=255&(Q=(tn=Z)+(en=b()))},function(){s(G),_n=G=0},function(){n.time++,nn||F()},F,function(){$(!nn)},D,function(){C(!nn)},function(){var n=k();s(G),_n=G=n},function(){Z=nn=255&(Q=(tn=Z)+(en=b())+(Q>>8&1))},function(){s(G),_n=G=8},function(){n.time++,256&Q||F()},function(){var n=l();cn=n>>8,an=255&n},function(){$(!(256&Q))},function(){var t=b()|Z<<8;n.out(t,Z),_n=t+1&255|65280&t,n.time+=4},function(){C(!(256&Q))},function(){s(cn<<8|an)},function(){Z=nn=255&(Q=(tn=Z)+(en=~b())+1)},function(){s(G),_n=G=16},function(){n.time++,256&Q&&F()},c,function(){$(256&Q)},function(){var t=b()|Z<<8;_n=t+1,Z=n.inp(t),n.time+=4},function(){C(256&Q)},function(){z(221)},function(){Z=nn=255&(Q=(tn=Z)+(en=~b())+(Q>>8&1^1))},function(){s(G),_n=G=24},function(){n.time++,4&t()^4&&F()},function(){fn=l()},function(){$(4&t()^4)},function(){_n=l(),s(fn),fn=_n,n.time+=2},function(){C(4&t()^4)},function(){s(fn)},function(){tn=~(Z=Q=nn=Z&b()),en=0},function(){s(G),_n=G=32},function(){n.time++,4&t()&&F()},function(){G=fn},function(){$(4&t())},function(){var n=fn;fn=cn<<8|an,cn=n>>8,an=255&n},function(){C(4&t())},T,function(){tn=256|(Z=Q=nn=Z^b()),en=0},function(){s(G),_n=G=40},function(){n.time++,128&Q||F()},function(){i(l())},function(){$(!(128&Q))},function(){z(243)},function(){C(!(128&Q))},function(){s(Z<<8|t())},function(){tn=256|(Z=Q=nn=Z|b()),en=0},function(){s(G),_n=G=48},function(){n.time++,128&Q&&F()},function(){on=fn,n.time+=2},function(){$(128&Q)},function(){z(251)},function(){C(128&Q)},function(){z(253)},function(){m(b())},function(){s(G),_n=G=56}],Tn=[,,,,,,,,,function(n){return g(n,un<<8|rn)},,,,,,,,,,,,,,,,function(n){return g(n,cn<<8|an)},,,,,,,,k,function(t){var e=k();n.put(e,255&t),
n.time+=3,n.put(_n=e+1&65535,t>>8),n.time+=3},function(t){return t=t+1&65535,n.time+=2,t},function(n){return 255&n|d(n>>8)<<8},function(n){return 255&n|p(n>>8)<<8},function(n){return 255&n|b()<<8},,,function(n){return g(n,n)},function(t){var e=k();return _n=e+1,t=n.get16(e),n.time+=6,t},function(t){return t=t-1&65535,n.time+=2,t},function(n){return-256&n|d(255&n)},function(n){return-256&n|p(255&n)},function(n){return-256&n|b()},,,,,,function(t){var e=N(t),i=d(n.get(e));n.time+=4,n.put(e,i),n.time+=3},function(t){var e=N(t),i=p(n.get(e));n.time+=4,n.put(e,i),n.time+=3},function(t){var e,i=N(t);n.time+=-5,e=b(),n.time+=2,n.put(i,e),n.time+=3},,,function(n){return g(n,on)},,,,,,,,,,,function(n){un=n>>8},function(n){un=255&n},function(n){un=I(n)},,,,,,function(n){rn=n>>8},function(n){rn=255&n},function(n){rn=I(n)},,,,,,function(n){cn=n>>8},function(n){cn=255&n},function(n){cn=I(n)},,,,,,function(n){an=n>>8},function(n){an=255&n},function(n){an=I(n)},,function(n){return 255&n|un<<8},function(n){return 255&n|rn<<8},function(n){return 255&n|cn<<8},function(n){return 255&n|an<<8},,function(n){return 255&n|(255&n)<<8},function(n){fn=255&fn|I(n)<<8},function(n){return 255&n|Z<<8},function(n){return-256&n|un},function(n){return-256&n|rn},function(n){return-256&n|cn},function(n){return-256&n|an},function(n){return-256&n|n>>8},,function(n){fn=-256&fn|I(n)},function(n){return-256&n|Z},function(t){n.put(N(t),un),n.time+=3},function(t){n.put(N(t),rn),n.time+=3},function(t){n.put(N(t),cn),n.time+=3},function(t){n.put(N(t),an),n.time+=3},function(t){n.put(N(t),fn>>8),n.time+=3},function(t){n.put(N(t),255&fn),n.time+=3},,function(t){n.put(N(t),Z),n.time+=3},,,,,function(n){Z=n>>8},function(n){Z=255&n},function(n){Z=I(n)},,,,,,function(n){Z=nn=255&(Q=(tn=Z)+(en=n>>8))},function(n){Z=nn=255&(Q=(tn=Z)+(en=255&n))},function(n){Z=nn=255&(Q=(tn=Z)+(en=I(n)))},,,,,,function(n){Z=nn=255&(Q=(tn=Z)+(en=n>>8)+(Q>>8&1))},function(n){Z=nn=255&(Q=(tn=Z)+(en=255&n)+(Q>>8&1))},function(n){Z=nn=255&(Q=(tn=Z)+(en=I(n))+(Q>>8&1))},,,,,,function(n){Z=nn=255&(Q=(tn=Z)+(en=~(n>>8))+1)},function(n){Z=nn=255&(Q=(tn=Z)+(en=~(255&n))+1)},function(n){Z=nn=255&(Q=(tn=Z)+(en=~I(n))+1)},,,,,,function(n){Z=nn=255&(Q=(tn=Z)+(en=~(n>>8))+(Q>>8&1^1))},function(n){Z=nn=255&(Q=(tn=Z)+(en=~(255&n))+(Q>>8&1^1))},function(n){Z=nn=255&(Q=(tn=Z)+(en=~I(n))+(Q>>8&1^1))},,,,,,function(n){tn=~(Z=Q=nn=Z&n>>8),en=0},function(n){tn=~(Z=Q=nn=Z&n&255),en=0},function(n){tn=~(Z=Q=nn=Z&I(n)),en=0},,,,,,function(n){tn=256|(Z=Q=nn=Z^n>>8),en=0},function(n){tn=256|(Z=Q=nn=Z^255&n),en=0},function(n){tn=256|(Z=Q=nn=Z^I(n)),en=0},,,,,,function(n){tn=256|(Z=Q=nn=Z|n>>8),en=0},function(n){tn=256|(Z=Q=nn=Z|255&n),en=0},function(n){tn=256|(Z=Q=nn=Z|I(n)),en=0},,,,,,function(n){m(n>>8)},function(n){m(255&n)},function(n){m(I(n))},,,,,,,,,,,,,E,,,,,,,,,,,,,,,,,,,,,,l,,function(t){return _n=l(),s(t),n.time+=2,_n},,s,,,,function(n){G=n},,,,,,,,,,,,,,,,function(t){on=t,n.time+=2}],Dn=[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(){un=U()},function(){q(un)},function(){R(~(un<<8|rn),1)},function(){var t=k();n.put(t,rn),n.time+=3,n.put(_n=t+1&65535,un),n.time+=3},K,X,J,function(){xn=255&xn|Z<<8,n.time++},function(){rn=U()},function(){q(rn)},function(){R(un<<8|rn,0)},function(){var t=k();_n=t+1,t=n.get16(t),un=t>>8,rn=255&t,n.time+=6},K,X,J,function(){o(Z),n.time++},function(){cn=U()},function(){q(cn)},function(){R(~(cn<<8|an),1)},function(){var t=k();n.put(t,an),n.time+=3,n.put(_n=t+1&65535,cn),n.time+=3},K,X,Y,function(){O(xn>>8)},function(){an=U()},function(){q(an)},function(){R(cn<<8|an,0)},function(){var t=k();_n=t+1,t=n.get16(t),cn=t>>8,an=255&t,n.time+=6},K,X,W,function(){O(128&xn|$n)},function(){fn=255&fn|U()<<8},function(){q(fn>>8)},function(){R(~fn,1)},function(){var t=k();n.put(t,255&fn),n.time+=3,n.put(_n=t+1&65535,fn>>8),n.time+=3},K,X,J,L,function(){fn=-256&fn|U()},function(){q(255&fn)},function(){R(fn,0)},function(){var t=k();_n=t+1,fn=n.get16(t),n.time+=6},K,X,J,M,U,function(){q(0)},function(){R(~on,1)},function(){var t=k();n.put(t,255&on),n.time+=3,n.put(_n=t+1&65535,on>>8),n.time+=3},K,X,Y,,function(){Z=U()},function(){q(Z)},function(){R(on,0)},function(){var t=k();_n=t+1,on=n.get16(t),n.time+=6},K,X,W,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(){H(1,0)},function(){j(1,0)},function(){B(4)},function(){B(5)},,,,,function(){H(-1,0)},function(){j(-1,0)},function(){B(-4)},function(){B(-3)},,,,,function(){H(1,1)},function(){j(1,1)},function(){B(6)},function(){B(7)},,,,,function(){H(-1,1)},function(){j(-1,1)},function(){B(-2)},function(){B(-1)}],En=[function(n){un=P(n,un)},function(n){rn=P(n,rn)},function(n){cn=P(n,cn)},function(n){an=P(n,an)},function(n){fn=255&fn|P(n,fn>>8)<<8},function(n){fn=-256&fn|P(n,255&fn)},function(t){var e=P(t,n.get(fn));n.time+=4,n.put(fn,e),n.time+=3},function(n){Z=P(n,Z)},function(n){V(n,un)},function(n){V(n,rn)},function(n){V(n,cn)},function(n){V(n,an)},function(n){V(n,fn>>8)},function(n){V(n,255&fn)},function(t){V(t,n.get(fn)),Q=384&Q|_n>>8&40,n.time+=4},function(n){V(n,Z)}],An=[function(n){un&=~n},function(n){rn&=~n},function(n){cn&=~n},function(n){an&=~n},function(n){fn&=~(n<<8)},function(n){fn&=~n},function(t){var e=n.get(fn)&~t;n.time+=4,n.put(fn,e),n.time+=3},function(n){Z&=~n},function(n){un|=n},function(n){rn|=n},function(n){cn|=n},function(n){an|=n},function(n){fn|=n<<8},function(n){fn|=n},function(t){var e=n.get(fn)|t;n.time+=4,n.put(fn,e),n.time+=3},function(n){Z|=n}]}!function(i){function o(t,e){$$(t).forEach(function(t){n(t,"active",e),t.checked=e})}function r(t){var e,i,u=pn;(e=t.model)!=i&&(o(".c-128",e),u[128]=!!e||i),(e=c(t.ay,e))!=i&&(o(".c-ay",e),u.ay=!!e||i),(e=t.tc2048)!=i&&(u.tc2048=!!e||i),(e=t.mute)!=i&&(o(".c-mute",e),n("body","mute",e)),(e=t.volume)!=i&&($("#vol>*>*").style.width=100*e+"%")}function c(n,t){return null==n?t:n}function a(n){emu.zx.setState(n);var t,e,i;(t=n.volume)!=i&&(tn=t,e=1),(t=n.mute)!=i&&(en=t,e=1),e&&emu.zx.volume(en?0:tn),(t=n.speed)!=i&&(emu.speed=0|t||1),r(n)}function f(){var n,t,e,i,o,u,r=3&on,c=emu.zx.dim,a=innerWidth,f=innerHeight,s=a,l=f,m=0;switch(n=512-a,n>0&&(a+=n>>3),r&&(a=15*a>>4,m=f>>5,f=15*f>>4,i=l-f>>2),n=c[0]*f,t=c[1]*a,n>t?f-=f-t/c[0]|0:a-=a-n/c[1]|0,e=s-a>>1,o=V.w,u=G.w,t=s-48,r){case 1:o>t&&(o=t),n=o+i,n>e&&(e=n);break;case 2:u>t&&(u=t),n=s-a-u-i,e>n&&(e=n);break;case 3:t>>=1,o>t&&(o=t),u>t&&(u=t)}var d=$("#c").style;d.width=a+"px",d.height=f+"px",d.left=e+"px",d.top=m+"px",d=V.e.style,d.left=(1&r?0:-V.w)+"px",d.width=o+"px",d=G.e.style,d.right=(2&r?0:-G.w)+"px",d.width=u+"px",emu.canvas(P,f),n=l-f,fn=!r&&n>127?f:0,d=$("#k").style,d.height=n+"px",d.display=fn?"block":"none",fn&&kbd_layout(s,n,f)}function s(n){return un=Y.activeElement,$("#vol").contains(n.target)?N(n):void 0}function l(n){var e=n.target,o=e.className;return o&&(o=o.match(/\bc-(\S+)/),o&&!e.disabled)?void i.cmd(o[1]):t(e,"#s,button")?("s"==e.id&&(e=$("#c")),void e.focus()):$("#vol").contains(e)?N(n):(e=Y.activeElement,j(n,un!=e&&"click+focus"),void(un=e))}function m(e){var o=e.type,u=[e.pageX,e.pageY];if("mouseout"==o)return void(null===e.relatedTarget&&clearTimeout(an));if(rn)return rn(e,o,u);var r,c,a,f=cn;return cn=u,"m"!=o[0]&&(r=v(e)),!f||(c=u[0]-f[0])||(a=u[1]-f[1])?(n("body","+move"),clearTimeout(an),an=Z(function(){if(n("body","-move"),f){var o,u=e.target;return t(u,".tabv>button")?u.focus():void(j(e,"hover")||(o=f[1],32>o||innerHeight-o<33||fn&&o>=fn||(o=f[0],0>=c&&32>o&&i.show(1,1),c>=0&&innerWidth-o<33&&i.show(2,2))))}},200),r):r}function d(n){var t,e=n.target,o=n.keyCode,u=n.type,r="keydown"==u,c=n.ctrlKey,a=emu.stop("user");45==o&&(t=$("[rel=search]"))&&t.click();n:if(!on&&(112>o||o>123)&&19!=o&&46!=o){if((27==o||32==o)&&r&&a)i.cmd("pause");else if(o>32&&35>o)N(n);else{if(a)break n;"keypress"!=u&&emu.kbd(~o,"keyup"!=u,n.shiftKey+2*(c|n.altKey|n.metaKey))}return!function(n,t){t=this["lo"+n+"on"],/^\w+:..t[^.]+k\.c/.test(t)||Z(function(){emu.kbd()},2e4)}("cati"),K(n)}if(t={19:"pause",112:"help",113:"remember",114:"restore",116:"update",121:"mute"}[o],t&&K(n),r){if(t)return void i.cmd(t);if(c)return t={46:"reset",79:"open",83:"save"}[o],46==o&&emu.kbd(),i.cmd(t),K(n);if(27!=o&&120!=o||i.show(3,27==o?0:3^on&&3),"vol"!=e.id||o-38&-3||N(n),"BUTTON"==e.nodeName)if(37==o||39==o){t=37==o?"previous":"next";do e=e[t+"ElementSibling"];while(e&&e.hidden);e&&"BUTTON"==e.nodeName&&e.focus()}else 40==o&&(t=e.dataset.down,t&&$("#"+t).focus());j(n)}}function p(n){var e="focus"==n.type,o=n.target;return"c"==o.id?e?void i.show(3,0):(emu.kbd(),void Z(function(){Y.activeElement==o||on||i.show(3,3)})):void(e&&(t(o,"#l *")&&i.show(1,1),t(o,"#r *")&&i.show(2,2),t(o,".tabv>button")&&I(o)))}function v(n){var t,e=n.type,o=n.dataTransfer||n.clipboardData;return o.dropEffect="copy",K(n),("drop"==e||"paste"==e)&&((t=o.files)&&(t=t[0])||(t=o.getData("URL"))?void i.load(t):(t=o.getData("Text"),void(t&&emu.kbd(t))))}function h(n){var t=n.type,e=n.dataTransfer||n.clipboardData,i=n.target;if(i!=P&&"c"!=i.id)return j(n);if("dragstart"==t||"copy"==t){A(e);var o,u=$e("canvas"),r=$e("img"),c=emu.zx.dim;u.height=o=c[1]>>1,u.width=c=c[0]>>1,u.getContext("2d").drawImage(P,0,0,P.width,P.height,0,0,c,o),r.src=u.toDataURL(),e.setDragImage(r,c/2,o/2)}return!0}function g(n){ln=[].map.call(n.touches,function(n){return[n.pageX,n.pageY]}),sn(),"m"==n.type[5]&&K(n)}function b(n){var t,e,i,o,u=Q.hash.substr(1),r=$("#bb"),c=decodeURIComponent;if(n||u!=r.value){for(r.value=u,t={};u;){if(e=u.match(/^!([^#]*)#?(.*)/))i="!",o=c(e[1]),u=e[2];else{if(e=u.match(/^(~?)([^=#%./]*)([./]?)(?:=([^#]*))?#?(.*)/),e[3]){t.l=u;break}i=e[2],o=!e[1]&&(null==e[4]||c(e[4])),u=e[5]}t[i]=o}return t}}function k(n){if(n){var t,e,o,e,u,r=pn;r.u!=n.u&&(r.u=e=n.u,t=$("[data-for=userg]"),t.hidden=!e,t.style.display=e?"":"none",L("user",e||null),e&&t.focus()),(e=n["!"])&&(u=e.match(/^([a-z0-9]+)(:[a-z0-9]+)?$/))?(r.l=null,i.load(J+e,1),vn.hasOwnProperty(e)?x():(vn[u[1]]=null,request({url:J+u[1]+".info"},{text:1,acc:nn,nopb:1},function(n){var t=n.data;if(t){var e=JSON.parse(t),i=e.id;i&&(vn[i]=e,x())}}))):r.l!=n.l&&(r.l=o=n.l);var c,f={};(e=n[128])!=c&&(f.model=+!!e),(e=n.tc2048)!=c&&(f.tc2048=+!!e),(e=n.ay)!=c&&(f.ay=+!!e),(e=n.speed)!=c&&(f.speed=e),a(f),o&&i.load(o)}}function y(t){$("h1").onclick=function(){i.cmd("update")},t.onupdateready=function(){mn=1,t.swapCache(),n("body","+update")}}function w(n){var t=Q.href.replace(/#.*/,"");if((n||/^#!/).test(Q.hash))try{history.replaceState(null,null,t)}catch(n){Q.replace(t+"#")}onhashchange()}function x(){var n=Q.hash.match(/^#!([a-z0-9]+)/),t=dn;n&&(t||(dn=t=Y.title),n=vn[n[1]],n&&(t=n.name+" \u2022 ZX Spectrum online")),t&&(Y.title=t)}function S(){function n(){var n,i,o,u=$e("canvas"),r=u.getContext("2d");u.width=n=e.width,u.height=i=e.height,r.drawImage(e,0,0),emu.stop("user")&&(r.scale(n/16,i/16),r.fillStyle="#FFF",r.fillRect(9,9,7,7),r.fillStyle="#33C",r.fillRect(10,10,2,5),r.fillRect(13,10,2,5)),t=(o=t).cloneNode(1),t.type="image/png",t.href=u.toDataURL(),o.parentNode.replaceChild(t,o)}var t=$("link[rel~=icon]"),e=new Image;e.src=t.href,e.onload=function(){(S=n)()}}function C(){try{var n,t,e,o,u,r=localStorage,c="qaop-state";if(n=r[c])for(r.removeItem(c),u=JSON.parse(n.substr(1<<17)),u.ram=[],t=0;8>t;t++)for(u.ram[t]=o=bytes(16384),e=0;16384>e;e++)o[e]=n.charCodeAt(t<<14|e)}catch(n){i.msg(n)}return onunload=function(){var n=emu.zx.getState(),t=n.ram;n.pause=emu.stop("user"),n.volume=tn,n.mute=en,n.speed=emu.speed,delete n.ram,r[c]=t.reduce(function(n,t){return n+B(t)},"")+JSON.stringify(n)},u}function F(){var n,t,e=M("snaps"),i=[],o=e.o.slice(),u=localStorage;for(n=0;n<u.length;)/^zx\/./.test(t=u.key(n++))&&i.push(t.substr(3));i.sort(),i=i.filter(function(n){var t=o.indexOf(n);return 0>t?1:void delete o[t]}),o.forEach(function(n,t){q(e,t)}),i.forEach(function(n){U(e,n,n)}),e.act=T}function _(n,t){var e=$("#save");e.href=t,e.textContent=e.download=n,e.click()}function z(){$(".c-restore").disabled=!hn.snaps.o.length}function T(n,t,o){var u=this,r=u.o.length;switch(n){case"click":o||$("#c").focus();case"drag":var c=u.o[t]||u.o[r-1],a=c&&localStorage["zx/"+c];if(!c||!a)return;if("drag"==n)return A(o,c,a);i.load(a);break;case"sel":$(".c-svsna").disabled=$(".c-rmsna").disabled=0>t,t>=0&&e(u.e[t]);break;case"del":t>=0&&(localStorage.removeItem("zx/"+u.o[t]),q(u,t),z())}}function D(){var t,e,o,u,r,c=new Date;for(t=[c.getMonth()+1,c.getDate(),c.getHours(),c.getMinutes()].reduce(function(n,t,e){return n+"-- :"[e]+("0"+t).substr(-2)},c.getFullYear()),o=hn.snaps,r=0,e=t;u=o.o.indexOf(e),!(0>u||u==o.sel);e=t+" ("+ ++r+")");u=o.sel;try{u>=0&&localStorage.removeItem("zx/"+o.o[u]),localStorage["zx/"+e]=E()}catch(n){return i.msg(n)}0>u?n(o.e[u=U(o,e,e)],"+sel"):o.e[u].firstChild.textContent=o.o[u]=e,o.act("sel",o.sel=u),z()}function E(n){return"data:application/x.zx.z80;base64,"+btoa(u(n||emu.zx.getState()))}function A(n,t,e,i,o){if(e=e||E(),n.setData("URL",e),!i){if(i=e.match(/^data:([^,;]+)/),!i)return;i=i[1]}o=o||emu.getType(i),o&&(t=(t||"snapshot")+"."+o,n.setData("DownloadURL",i+":"+t.replace(/:/g,"")+":"+e))}function N(n){function t(n){var t=$("#vol>*").getBoundingClientRect();e((n-t.left)/t.width)}function e(n){a({volume:0>n?0:n>1?1:n})}var i,o,u=tn,r=n.pageX;switch(n.type){case"keydown":o={33:1,34:-1,37:-1,38:1,39:1,40:-1}[n.keyCode],o&&(e(u+.1*o),i=1);break;case"mousedown":if(o=$("#vol>*>*>*").getBoundingClientRect(),r-=o.left,0>r||r>=o.width)return;r-=o.width/2,rn=function(n,e,o){if(t(o[0]-r),i=1,"mouseup"==e){if(i){var u=onclick;onclick=null,Z(function(){onclick=u})}rn=null}};break;case"click":t(r)}return i}function I(t){[].forEach.call(t.parentNode.children,function(e){var i=e.getAttribute("data-for"),o=e==t;n(e,"active",o),e.tabIndex=o-1,i&&($("#"+i).style.visibility=o?"visible":"hidden")})}function R(n,t){if("click"==n){$("#bb").value="";var e=this.o[t];e.id?(Q.hash="#!"+e.id,onhashchange()):i.load(e.url),$("#c").focus()}}function L(n,t){var e,o=M(n);o.rq&&o.rq.abort(),null!=t&&(o.act=R,e=$e("a"),e.href=t,o.rq=request({url:e.href},{text:1,acc:nn+",text/plain,text/html",color:"#EC0"},function(n){function t(){if(r==nn){if(u=JSON.parse(c),!u.forEach)throw"Not a table"}else"text/html"==r?(u=$e("div"),u.innerHTML=c,u=[].map.call(u.querySelectorAll("a:not([rel=up])"),function(n){return{name:n.textContent,url:n.href}})):u=c.split(/\n+/).map(function(n){return{url:n}}),u=u.filter(function(n){return n.url?(n.name||(n.name=n.url.replace(/.*\//,"")),n):void 0})}var u,r=n.type,c=n.data,a=$e("base");if(n.eof&&(delete o.rq,o.ul.innerHTML="",c&&r)){r=r.replace(/ *;.*/,""),a.href=n.url,Y.head.insertBefore(a,Y.head.firstChild);try{t(),u.forEach(function(n){var t=n.name,i=n.url;t&&i&&U(o,t+"",{url:(e.href=i,e.href)})})}catch(n){i.msg(n)}Y.head.removeChild(a)}}),o.ul.innerHTML="\u2652")}function M(n){var t=hn[n];return t.e=[],t.o=[],t.sel=-1,t.ul.innerHTML="",t}function O(t,i){i>=0&&e(t.e[i]),t.e.forEach(function(t,e){n(t,"sel",e==i)}),t.act("sel",t.sel=i)}function U(n,t,e){var i=$e("li"),o=i.appendChild($e("a"));return o.textContent=t,n.ul.appendChild(i),n.e.push(i),o.draggable=!0,n.o.push(e)-1}function q(n,t){n.ul.removeChild(n.e[t]),n.e.splice(t,1),n.o.splice(t,1);var e=n.sel;e-=e>t||e==t&&t==n.e.length,O(n,e)}function H(n){var e,i,o,u;t(n,".ls>li>a")?n=(e=(i=n).parentNode).parentNode:t(n,".ls>li")&&(n=n.parentNode);for(u in hn)if((o=hn[u]).ul==n)return{l:o,i:o.e.indexOf(e),e:e,a:i}}function j(n,t){if(e=H(n.target)){var e,i=e.l,o=e.i,u=i.sel;switch(t||n.type){case"click":u=o;case"click+focus":o>=0&&!(n.which>1)&&i.act("click",o,n.ctrlKey);break;case"hover":o>=0&&(u=o);break;case"keydown":switch(n.keyCode){case 38:u>0&&u--;break;case 40:u+1<i.e.length&&u++;break;case 13:u>=0&&i.act("click",u,n.ctrlKey);break;case 46:return i.act("del",u),1;case 27:u=-1;break;default:return void i.act("key",-1,n)}K(n);break;case"dragstart":if((u=o)<0)break;i.act("drag",o,n.dataTransfer)}return i.sel!=u&&O(i,u),1}}function B(n){return String.fromCharCode.apply(String,n)}function K(n){n.preventDefault()}function X(){n("body","-anim")}var J="http://colorclash.tk/",Y=document,W=i.embed,P=$("#s"),V={e:$("#l"),w:256},G={e:$("#r"),w:272},Z=setTimeout,Q=location,nn="application/json";i.init=function(){(onresize=f)(),onclick=l,onmousemove=onmouseout=onmouseup=ondragenter=ondragover=ondragleave=m,onmousedown=s,ontouchstart=ontouchmove=ontouchend=g,onkeydown=onkeypress=onkeyup=d,addEventListener("focus",p,1),addEventListener("blur",p,1),$("#c").oncopy=ondragstart=ondrag=ondragend=h,Y.onpaste=ondrop=v;var t,e;W||(t=C(),t||Z(function(){i.msg("F9 - menu",5e3)},300)),e=b(W)||{},e["!"]&&(t={iff:0,halted:1,volume:t&&t.volume});var o=0;W||(t&&(emu.stop("user")^t.pause&&i.cmd("pause"),a(t)),I($(".tabv>:last-child")),o=e.snaps<<1|!!e.u<<1|e.menu,i.show(3,3)),onhashchange=function(){k(b())},Z(function(){k(e)}),Z(function(){i.show(3,o)}),(e.snaps||e.menu)&&w(/./),emu.stop("load",0);var u="files"in $("input[type=file]"),c=emu.audio;n("body",c?"+audio":"+noaudio"),$$(".c-pause,.c-reset,.c-128,.c-ay,.c-remember,.c-save"+(u?",.c-open":"")+(c?",#vol,.c-mute":"")).forEach(function(n){n.disabled=0}),P.ondblclick=function(){i.cmd("pause")},P.draggable=!0,W||((onstorage=F)(),z()),Y.body.removeChild($("#splash"));var x=window.applicationCache;x&&y(x),onmessage=function(n){var t,e=n.data;if(e==e+"")if(t=e.match(/^([^ ]+) ([^ ]+)/))switch(t[1]){case"load":i.load(t[2]);break;case"model":r(emu.setModel(t[2]));break;case"keydn":case"keyup":emu.kbd(+t[2],"keydn"==t[1])}else i.cmd(n.data)},top.postMessage("hello","*")};var tn=.5,en=0;i.cmd=function(t,e){function u(){return m=hn.snaps}var r=null==e;switch(t){case"pause":r&&(e=!emu.stop("user")),emu.stop("user",e),n(Y.body,"pause",e),o(".c-pause",e),S();break;case"reset":emu.reset(),w();break;case"open":var c=$("#open");c.onchange=function(){var n=c.files[0];n&&i.load(n),c.value=""},c.click();break;case"save":try{e=e||"snapshot",/\.z80$/i.test(e)||(e+=".z80"),_(e,E())}catch(n){i.msg(n)}break;case"128":r&&(e=!emu.zx.getState().model),a({model:e});break;case"ay":r&&(e=!emu.zx.getState().ay),a({ay:e});break;case"mute":r&&(e=!en),a({mute:e});break;case"remember":D();break;case"restore":u().act("click",m.sel);break;case"rmsna":u().act("del",m.sel);break;case"svsna":var f=u().o[m.sel],s=localStorage["zx/"+f];s.match(/^data:/)&&_(f+".z80",s);break;case"update":var l=window.applicationCache;if(l&&!mn)switch(l.status){case 1:l.update();case 2:case 3:return}w(/./),Q.reload();break;case"help":$("[rel=help]").click()}var m},i.load=function(n,t){t||w(),emu.load("snap",n,r)};var on;i.show=function(t,e){W&&(e&=-4);var i=on&~t^e;if(i==on)return i;var o=Y.body;return 3&(on^i)&&n(o,"anim",null!=on),n(o,"full",!(3&i)),on=i,f(),$("#c")[3&i?"blur":"focus"](),i};var un,rn,cn,an,fn,sn,ln=[];!function(){var n;$("#k").onmousedown=function(t){(rn=function(t,e){"mouseup"==e?rn=n=null:n=[t.pageX,t.pageY],sn()})(t),emu.stop("user")&&i.cmd("pause")};var t,e,o,u,r,c,a=[];sn=function(){var i,f,s=ln;n&&(s=s.slice(),s.push(n)),fn&&s.map(function(n){var i,f,s,l=n[1]-t;l>=0&&(f=l/o|0,4>f&&e>l-f*o&&(i=n[0]-u,i>=0&&(s=i/c|0,10>s&&r>i-s*c&&(s=5>s?3-f|s<<3:4+f|9-s<<3,a[s]|=2))))});for(i in a)f=a[i],f&&(3>f&&emu.kbd(+i,f>1),a[i]=f>>1)},kbd_layout=function(n,i,a){var f=n>>7;c=(n-f)/10|0,r=c-f,u=n-10*c+f>>1,o=i-f>>2,t=f,e=o-f,e>r&&(o=(e=r)+f);var s,l,m,d,p,v,h=$("#k"),g=t,b="1234567890QWERTYUIOPASDFGHJKL  ZXCVBNM  ";for(v=s=0;4>s;s++){for(m=u,l=0;10>l;l++,v++)p=h.children[v],p||(p=h.appendChild($e("div")),p.textContent=b[v]),d=p.style,d.top=g+"px",d.left=m+"px",d.width=r+"px",d.height=e+"px",m+=c;g+=o}t+=a}}();var mn,dn,pn={},vn={},hn={snaps:{ul:$("#snaps")},user:{ul:$("#userg")}};addEventListener("transitionend",X,0),addEventListener("webkitTransitionEnd",X,0)}(ui),emu=function(){function n(n,t,e){var i,o,u=p.keyboard;n:{for(i=0;i<b.length;i++)if(n==b[i]){t||b.splice(i,1);break n}t&&b.push(n)}for(i=0;i<b.length;i++){if(o=b[i],0>o){if(o=k[~o],null==o)continue;switch(1&e&&(o>>=8),o&=255,o>>6){case 1:u[0]&=254,u[7]|=2;break;case 2:u[7]&=253,u[0]|=1}}u[7&o]&=~(1<<(o>>3&7))}}function t(n){var t,e,i=0,o=0,u=0,r=p.keyboard;y=function(){if(!i){if(o==n.length)return void(y=null);if(e=1+"aq10p\n zsw29ol xde38ikmcfr47ujnvgt56yhb AQ  P  ZSW  OL XDE  IKMCFR  UJNVGT  YHB   !_\"  :  @);= \xa3  #( +.? <$' -,/ >%& ^* ~   \xa9   |       \\       {   ]   }   [".indexOf(n[o++]),!e)return;t=e%40,e=(e-t)/40,3==e&&(u^e?(o--,t=0):e--),u=e,r[0]=254|1&u^1,r[7]=253|2&u^2,r[7&t]&=~(1<<(t>>3)),i=5}3==--i&&(r[7&t]|=1<<(t>>3))}}function e(n){v(function(t){return g.length?d=0:n>t?e(n):(n+20>t?t=n:n+40>t&&(u(1),t=n+20),u(),void e(t+20))})}function u(n){if(n=n?0:2,x)p.frame(n),r();else{for(var t=h.speed;t--;)y&&y(),p.frame(t?1:5|n);h.tape&&r()}}function r(){function n(n){r.ix=l,r.de=m,r.hl=s<<8|f,r.a=d,n>=0&&(v=n,r.pc=c(r),x=null),r.f=v,p.setState(r),u.pos=e}function t(n){var t=u.data;return 255&(t.charCodeAt?t.charCodeAt(n):t[n])}var e,i,o,u=x,r=p.cpu.getState();if(1&r.iff||(i=r.pc)<1387||i>1540)return void(x=null);if(r=p.getState(1),u)e=u.pos,o=u.data.length;else{if(!(16&r.p7FFD))return;if(i>=1507&&(i=c(r),1510==i&&(i=c(r))),1387>i||i>1422)return;if(u=h.tape,o=u.data.length,u.blk|=0,u.eof&&u.blk>=o&&(u.blk=0),e=u.blk+2,o>=e)u.blk=e+(t(e-2)|t(e-1)<<8);else if(!u.eof)return;x=u,r.a=r.a_,r.f=r.f_,r.pc=i,p.cpu.setState(r),r.hl&=255}for(var f=255&r.hl,s=r.hl>>8&255,l=r.ix,m=r.de,d=r.a,v=r.f;;){if(e==u.blk)return n(80);if(e>=o){if(u.eof)return n(80);break}if(f=t(e++),s^=f,!m)return n((d=s)<1|d-1&128|!(d-1)<<6|!(15&d)<<4|2);if(64&v){if(1&v)l>=16384&&(r.ram[l-16384]=f);else if(d=a(r,l)^f)return n(0);l=l+1&65535,m--}else{if(d^=f)return n(0);v|=64}}return n(-1)}function c(n){var t=n.sp;return n.sp=t+2&65535,a(n,t)|a(n,t+1&65535)<<8}function a(n,t){return 16384>t?p.rom48k[t]:n.ram[t-16384]}function f(n,t,e){if(e&&$[n]&&$[n].abort(),$[n]=t,t)switch(n){case"tape":x=null;break;case"snap":h.stop(n,0)}}function s(n,t){var e;if(n=n.toLowerCase(),t)e=n.match(/\S\.(\w{3})$/),n=e&&e[1];else if(e=n.match(/^(application|image)\/(x\.zx\.|x-spectrum-)([-.a-z0-9]+)/),n=e&&e[3],n&&"i"==e[1][0]&&"scr"!=n)return;return"slt"==n&&(n="z80"),n&&~["rom","sna","z80","tap","scr"].indexOf(n)?n:void 0}function l(n){return 1-/^48k?$|^0$/i.test(n)}var d,p,v,h={speed:1},g=["load"];h.init=function(n,t,e){h.zx=p=new t(e),p.rom48k=n.shift(),p.rom128=n,p.init(),v=window.requestAnimationFrame||window.webkitRequestAnimationFrame;try{p.audio(i()),h.audio=1}catch(n){ui.msg(n)}};var b=[],k=[,,,18247,,,,,17476,20303,,,,1542,,,0,3855,3855,,,,,,,,,17219,,,,,1799,,,,,25443,23644,21588,25700,,,,,,,,1028,771,2827,4883,6939,8995,9252,7196,5140,3084,,34957,,38542,,,,257,10023,6168,4369,4626,6425,8481,9766,5397,7710,5654,3598,5911,7967,3341,1285,514,6682,2313,8738,7453,8224,2570,4112,9509,2056,0,3855,,,,,,,,,,,,,,42919,38550,,40606,,41120,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,33950,,,,,,,,,,,,,34957,38542,39583,33950,41623,39072,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34204];h.kbd=function(e,i,o){var u;if(e==u||e===+e){for(var r=0;8>r;r++)p.keyboard[r]=255;y=null,e==u?b=[]:n(e,i,o)}else t(e)},h.stop=function(n,t){var i=g,o=i.indexOf(n);if(t){if(~o)return;i.length||v||clearInterval(d),i.push(n)}else{if(null==t)return o>=0;if(0>o)return;if(i.splice(o,1),i.length)return;v?d||(d=1,e()):d=setInterval(u,20)}};var y,w;h.canvas=function(n,t){var e=p.dim,i=1+(t>=2*e[1]);i!=w&&(w=i,n.width=e[0],n.height=i*e[1]),p.canvas(n,i)},h.reset=function(){p.setState({rom:null,ay:""}),p.reset()};var x,$={};return h.load=function(n,t,e){function i(){h.tape={data:t.data,pos:0},a=function(){h.tape.data=t.data},m=function(){h.tape.eof=1}}function u(n){ui.progress({tap:"#0C3",rom:"#D04"}[n]||"#06F")}"string"==typeof t?t={url:t}:window.File&&t instanceof File&&(t={file:t,name:t.name,type:t.type});var r,c,a,m,d;"tape"==n&&i(),d=request(t,{},function(t){if(!a){if(t.type&&u(r=s(t.type)),!t.data)return f(n);r||(r=s(t.name||t.url,1),u(r)),"rom"==r||"sna"==r||"z80"==r||"scr"==r?(u(r),h.stop("snap",1),c=p.getState(2),c={ram:c.ram},a=o(c,t,r),m=function(){setTimeout(function(){h.stop("snap",0)},200)}):"tap"==r?"snap"==n&&(f(n="tape",d,1),p.command('\xef""'),c=t.type,c=c&&c.match(/; *model *= *([^ ]+)/),c=c&&l(c[1]),c=c||p.getState().model,c={model:c,p7FFD:c&&16},f("snap"),i()):(ui.msg("Unknown file type"),a=function(){})}if(a)try{var v=1;t.data&&a(),v=t.eof}finally{v&&(f(n),m&&m()),c&&(p.setState(c),e&&e(c))}}),f(n,d,1)},h.getType=s,h.setModel=function(n){return m=l(n),null!=m&&(m={model:m},p.setState(m)),m},h}(),setTimeout(function(n,t){n=n("L3RvcmluYWsu"),(!t||t.href.indexOf(n)<0)&&emu.stop(n,1)},1e6,atob,$("a[rel=author]")),ld(r,c)}();
